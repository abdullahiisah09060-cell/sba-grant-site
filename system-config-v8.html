<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBA MASTER | V8.2 COMMAND</title>
    <style>
        :root { --admin-red: #ba0c2f; --admin-blue: #00274c; --bg: #0f172a; }
        body { background: var(--bg); color: #f8fafc; font-family: sans-serif; margin: 0; font-size: 13px; padding-bottom: 50px; }
        
        .admin-nav { background: #1e293b; padding: 10px; border-bottom: 2px solid var(--admin-red); text-align: center; position: sticky; top:0; z-index:100; }
        
        .stats-wrapper { display: flex; gap: 8px; padding: 10px; overflow-x: auto; }
        .stat-card { flex: 1; background: #334155; padding: 8px; border-radius: 8px; text-align: center; min-width: 100px; }
        .stat-card h3 { font-size: 9px; margin: 0; color: #94a3b8; text-transform: uppercase; }
        .stat-card p { margin: 2px 0 0; font-size: 14px; font-weight: bold; color: #38bdf8; }

        .container { padding: 8px; max-width: 600px; margin: 0 auto; }
        .section-title { font-size: 10px; color: #38bdf8; text-transform: uppercase; margin: 15px 0 8px; font-weight: bold; display:flex; align-items:center; gap:5px; }
        
        /* EXPANDABLE USER CARD */
        .user-card { 
            background: #1e293b; 
            padding: 10px; 
            border-radius: 8px; 
            margin-bottom: 6px; 
            border: 1px solid #334155;
            transition: 0.3s;
        }
        .user-main { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .user-info b { font-size: 14px; color: #fff; display: block; }
        .bal { color: #10b981; font-weight: bold; font-size: 14px; }
        
        /* HIDDEN DETAILS SECTION */
        .user-details { 
            display: none; 
            margin-top: 10px; 
            padding-top: 10px; 
            border-top: 1px dashed #475569; 
            font-size: 11px;
            color: #94a3b8;
        }
        .user-card.active .user-details { display: block; }
        
        .math-btn { 
            background: #38bdf8; color: #0f172a; border: none; 
            width: 32px; height: 32px; border-radius: 50%;
            font-size: 14px; font-weight: 900; cursor: pointer;
            box-shadow: 0 2px 0 #0284c7;
        }

        /* TASK ITEMS */
        .req-item { background: #fff; color: #0f172a; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #f59e0b; }
        .req-item h2 { margin: 5px 0; font-size: 20px; color: #1e293b; font-weight: 800; }
        .img-preview { width: 100%; height: 120px; object-fit: cover; border-radius: 4px; margin: 5px 0; border: 1px solid #ddd; }
        
        .action-btn { padding: 10px; border-radius: 6px; font-size: 11px; font-weight: bold; border: none; cursor: pointer; flex: 1; }
        .btn-appr { background: #10b981; color: white; }
        .btn-rej { background: #64748b; color: white; }
        .btn-res { background: #f59e0b; color: white; }

        /* CHAT */
        .chat-card { background: #fff; color: #1e293b; border-radius: 8px; margin-bottom: 12px; overflow: hidden; }
        .chat-history { height: 160px; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 5px; background: #f1f5f9; }
        .msg { max-width: 85%; padding: 7px 11px; border-radius: 12px; font-size: 12px; line-height: 1.3; }
        .msg.admin { align-self: flex-end; background: var(--admin-blue); color: white; border-bottom-right-radius: 2px; }
        .msg.user { align-self: flex-start; background: #e2e8f0; border-bottom-left-radius: 2px; color: #000; }
        
        .reply-box { padding: 8px; display: flex; gap: 5px; background: #fff; }
        .reply-box input { flex: 1; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; outline:none; }
    </style>
</head>
<body>

    <div class="admin-nav">
        <b style="font-size: 14px;">COMMAND V8.2 | MASTER</b><br>
        <span id="adminEmail" style="font-size: 9px; color: #38bdf8;">CONNECTING...</span>
    </div>

    <div class="stats-wrapper">
        <div class="stat-card"><h3>Users</h3><p id="stat-users">0</p></div>
        <div class="stat-card"><h3>Tasks</h3><p id="stat-reqs">0</p></div>
        <div class="stat-card"><h3>Total $</h3><p id="stat-cash">$0</p></div>
    </div>

    <div class="container">
        <div class="section-title">ðŸ‘¤ ACTIVE CLIENTS (Tap to see details)</div>
        <div id="userList"></div>

        <div class="section-title">âš¡ ACTION REQUIRED</div>
        <div id="requestFeed"></div>

        <div class="section-title">ðŸ’¬ SUPPORT CHATS</div>
        <div id="chatFeed"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, getDoc, addDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5nOOx153po4nWh4irbmTAcxsCZaM1-9k",
            authDomain: "sba-grant-2026.firebaseapp.com",
            projectId: "sba-grant-2026",
            storageBucket: "sba-grant-2026.firebasestorage.app",
            messagingSenderId: "838430821326",
            appId: "1:838430821326:web:6438deacb334076a64f99f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === "liger4683@gmail.com") {
                document.getElementById('adminEmail').innerText = user.email;
            } else { window.location.href = "index.html"; }
        });

        // USERS LISTENER WITH EXPANDABLE DETAILS
        onSnapshot(collection(db, "users"), (snap) => {
            const list = document.getElementById('userList');
            let totalCash = 0; list.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                const bal = parseFloat(u.balance) || 0;
                totalCash += bal;
                
                const card = document.createElement('div');
                card.className = 'user-card';
                card.innerHTML = `
                    <div class="user-main" onclick="this.parentElement.classList.toggle('active')">
                        <div class="user-info">
                            <b>${u.fullName || 'User'}</b>
                            <div class="bal">$${bal.toLocaleString()}</div>
                        </div>
                        <button class="math-btn" onclick="event.stopPropagation(); window.doMath('${d.id}')">Â±</button>
                    </div>
                    <div class="user-details">
                        Email: <span style="color:#fff">${u.email}</span><br>
                        KYC Status: <span style="color:#38bdf8">${u.kycStatus || 'NOT STARTED'}</span><br>
                        User ID: ${d.id}
                    </div>
                `;
                list.appendChild(card);
            });
            document.getElementById('stat-users').innerText = snap.size;
            document.getElementById('stat-cash').innerText = "$" + totalCash.toLocaleString();
        });

        // TASK STREAM WITH IMAGE VISIBILITY
        onSnapshot(collection(db, "requests"), (snap) => {
            const feed = document.getElementById('requestFeed');
            let count = 0; feed.innerHTML = "";
            snap.forEach(d => {
                const r = d.data();
                if(r.status !== "PENDING") return;
                count++;
                const isKyc = r.type && r.type.includes("KYC");
                feed.innerHTML += `
                    <div class="req-item">
                        <div style="font-size:10px; color:#64748b;">${r.userName}</div>
                        <div style="font-weight:bold; font-size:14px;">${r.type}</div>
                        <h2>$${parseFloat(r.amount || 0).toLocaleString()}</h2>
                        
                        ${isKyc ? `
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
                                <img src="${r.frontImg}" class="img-preview" onclick="window.open(this.src)">
                                <img src="${r.backImg}" class="img-preview" onclick="window.open(this.src)">
                            </div>
                        ` : ''}

                        <div style="display:flex; gap:5px; margin-top:10px;">
                            <button onclick="window.processTask('${d.id}', '${r.userId}', 'APPROVE', '${r.type}', ${r.amount || 0})" class="action-btn btn-appr">APPROVE</button>
                            <button onclick="window.processTask('${d.id}', '${r.userId}', 'REJECT', '${r.type}', ${r.amount || 0})" class="action-btn btn-rej">REJECT</button>
                            ${isKyc ? `<button onclick="window.resendKYC('${d.id}', '${r.userId}')" class="action-btn btn-res">RESEND</button>` : ''}
                        </div>
                    </div>`;
            });
            document.getElementById('stat-reqs').innerText = count;
        });

        // SUPPORT CHATS
        onSnapshot(query(collection(db, "support_tickets"), orderBy("timestamp", "asc")), (snap) => {
            const chatFeed = document.getElementById('chatFeed');
            const groups = {};
            snap.forEach(sDoc => {
                const m = sDoc.data();
                if (!m.userId) return;
                if (!groups[m.userId]) groups[m.userId] = { name: m.userName || "User", msgs: [] };
                groups[m.userId].msgs.push(m);
            });
            chatFeed.innerHTML = "";
            Object.keys(groups).forEach(uid => {
                const g = groups[uid];
                chatFeed.innerHTML += `
                    <div class="chat-card">
                        <div style="padding:6px 10px; background:#e2e8f0; font-weight:bold; color:#00274c; font-size:11px;">${g.name.toUpperCase()}</div>
                        <div class="chat-history" id="chat-box-${uid}">${g.msgs.map(m => `<div class="msg ${m.sender === 'ADMIN' ? 'admin' : 'user'}">${m.message}</div>`).join('')}</div>
                        <div class="reply-box">
                            <input type="text" id="reply-input-${uid}" placeholder="Type reply...">
                            <button onclick="window.adminReply('${uid}', '${g.name}')" class="action-btn btn-appr" style="flex:0; padding:8px 15px;">SEND</button>
                        </div>
                    </div>`;
                const box = document.getElementById(`chat-box-${uid}`);
                if(box) box.scrollTop = box.scrollHeight;
            });
        });

        window.doMath = async (uid) => {
            const userRef = doc(db, "users", uid);
            const userSnap = await getDoc(userRef);
            const currentBal = parseFloat(userSnap.data().balance) || 0;
            const val = prompt(`Edit ${userSnap.data().fullName}\nCurrent: $${currentBal}\n\nAdd (500) or Subtract (-500):`, "0");
            if(val !== null && !isNaN(val)) await updateDoc(userRef, { balance: currentBal + parseFloat(val) });
        };

        window.processTask = async (docId, uid, action, type, amt) => {
            const uRef = doc(db, "users", uid);
            const rRef = doc(db, "requests", docId);
            try {
                if (action === 'APPROVE') {
                    if (type.includes("KYC")) await updateDoc(uRef, { kycStatus: "APPROVED" });
                    else if (type.includes("GRANT")) {
                        const snap = await getDoc(uRef);
                        await updateDoc(uRef, { balance: (snap.data().balance || 0) + amt });
                    }
                    await updateDoc(rRef, { status: "SUCCESSFUL" });
                } else {
                    await updateDoc(rRef, { status: "DECLINED" });
                }
            } catch (e) { alert(e.message); }
        };

        window.resendKYC = async (docId, uid) => {
            if(confirm("Delete this submission and let user try again?")) {
                await deleteDoc(doc(db, "requests", docId));
                await updateDoc(doc(db, "users", uid), { kycStatus: "NOT_STARTED" });
            }
        };

        window.adminReply = async (uid, name) => {
            const el = document.getElementById(`reply-input-${uid}`);
            if(!el.value) return;
            await addDoc(collection(db, "support_tickets"), {
                userId: uid, userName: name, message: el.value, sender: "ADMIN", timestamp: serverTimestamp()
            });
            el.value = "";
        };
    </script>
</body>
</html>
