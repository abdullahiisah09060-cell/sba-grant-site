<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, orderBy, serverTimestamp, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        // --- FIREBASE CONFIG (Required for the page to work) ---
        const firebaseConfig = {
            apiKey: "AIzaSyB5nOOx153po4nWh4irbmTAcxsCZaM1-9k",
            authDomain: "sba-grant-2026.firebaseapp.com",
            projectId: "sba-grant-2026",
            storageBucket: "sba-grant-2026.firebasestorage.app",
            messagingSenderId: "838430821326",
            appId: "1:838430821326:web:6438deacb334076a64f99f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const chatBox = document.getElementById('chatBox');
        const userMsg = document.getElementById('userMsg');
        const sendBtn = document.getElementById('sendBtn');

        const protocolHtml = `
            <div style="align-self: flex-start;">
                <div class="msg-bubble msg-admin">
                    <b style="color: #1e3a8a; font-size: 10px; display: block; margin-bottom: 4px;">SYSTEM PROTOCOL</b>
                    Welcome. This channel is monitored by SBA officials. State your inquiry regarding your 2026 allocation.
                </div>
            </div>`;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Listen for messages for this specific user
                const q = query(
                    collection(db, "support_tickets"), 
                    where("userId", "==", user.uid), 
                    orderBy("timestamp", "asc")
                );

                onSnapshot(q, (snapshot) => {
                    chatBox.innerHTML = protocolHtml;

                    snapshot.forEach((snapDoc) => {
                        const m = snapDoc.data();
                        if (!m.timestamp) return; 
                        
                        const isUser = m.sender === "USER";
                        const msgDiv = document.createElement('div');
                        msgDiv.style.alignSelf = isUser ? "flex-end" : "flex-start";
                        msgDiv.style.display = "flex";
                        msgDiv.style.flexDirection = "column";
                        msgDiv.style.width = "100%";

                        msgDiv.innerHTML = `
                            <div class="msg-bubble ${isUser ? 'msg-user' : 'msg-admin'}" style="align-self: ${isUser ? 'flex-end' : 'flex-start'}">
                                ${!isUser ? `<b style="color: #1e3a8a; font-size: 10px; display: block; margin-bottom: 4px;">SBA OFFICER</b>` : ''}
                                ${m.message}
                            </div>
                            <div class="msg-meta" style="text-align: ${isUser ? 'right' : 'left'}; align-self: ${isUser ? 'flex-end' : 'flex-start'}">
                                ${isUser ? 'SENT • ENCRYPTED' : 'RECEIVED • SECURE'}
                            </div>
                        `;
                        chatBox.appendChild(msgDiv);
                    });
                    chatBox.scrollTop = chatBox.scrollHeight;
                });
            } else {
                window.location.href = 'index.html';
            }
        });

        sendBtn.onclick = async () => {
            const text = userMsg.value.trim();
            const user = auth.currentUser;

            if(!text || !user) return;

            sendBtn.disabled = true;
            sendBtn.innerText = "TRANSMITTING...";

            try {
                const userSnap = await getDoc(doc(db, "users", user.uid));
                const userData = userSnap.data() || {};

                // 1. Send to chat record
                await addDoc(collection(db, "support_tickets"), {
                    userId: user.uid,
                    userName: userData.fullName || "User",
                    message: text,
                    sender: "USER",
                    timestamp: serverTimestamp()
                });

                // 2. Alert admin via request stream (This makes it pop up on your admin home)
                await addDoc(collection(db, "requests"), {
                    userId: user.uid,
                    userName: userData.fullName || "User",
                    userEmail: user.email,
                    type: "SUPPORT_INQUIRY",
                    message: text,
                    status: "NEW_MESSAGE",
                    timestamp: serverTimestamp()
                });

                userMsg.value = "";
            } catch (e) {
                console.error(e);
                alert("Connection lost. Please retry.");
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerText = "Send Secure Message";
            }
        };
    </script>
