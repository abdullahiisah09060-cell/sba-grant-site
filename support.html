<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBA | Secure Support</title>
    <style>
        body { background: #f1f5f9; margin: 0; font-family: Arial, sans-serif; }
        .header { background: #1e3a8a; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .chat-area { max-width: 500px; margin: 10px auto; background: white; height: 80vh; display: flex; flex-direction: column; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #messageDisplay { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #f8fafc; }
        
        /* THE FIX: Only text inside bubbles */
        .bubble { max-width: 75%; padding: 10px 14px; border-radius: 15px; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .user { align-self: flex-end; background: #1e3a8a; color: white; border-bottom-right-radius: 2px; }
        .admin { align-self: flex-start; background: #e2e8f0; color: #1e293b; border-bottom-left-radius: 2px; }
        
        .input-box { padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #1e3a8a; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="header">
    <strong>SBA SUPPORT</strong>
    <button onclick="location.href='dashboard.html'" style="background:none; border:1px solid white; font-size:12px;">BACK</button>
</div>

<div class="chat-area">
    <div id="messageDisplay">
        <div class="bubble admin">Secure session started. How can we help you today?</div>
    </div>
    <div class="input-box">
        <input type="text" id="userInput" placeholder="Write message...">
        <button id="sendBtn">SEND</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB5nOOx153po4nWh4irbmTAcxsCZaM1-9k",
        authDomain: "sba-grant-2026.firebaseapp.com",
        projectId: "sba-grant-2026",
        storageBucket: "sba-grant-2026.firebasestorage.app",
        messagingSenderId: "838430821326",
        appId: "1:838430821326:web:6438deacb334076a64f99f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            const q = query(collection(db, "support_tickets"), where("userId", "==", user.uid));
            onSnapshot(q, (snapshot) => {
                const display = document.getElementById('messageDisplay');
                // Don't clear the whole thing, just update
                display.innerHTML = '<div class="bubble admin">Secure session started. How can we help you today?</div>';
                
                const docs = snapshot.docs.sort((a,b) => (a.data().timestamp?.toMillis() || 0) - (b.data().timestamp?.toMillis() || 0));
                
                docs.forEach(d => {
                    const m = d.data();
                    const div = document.createElement('div');
                    div.className = `bubble ${m.sender === 'USER' ? 'user' : 'admin'}`;
                    div.innerText = m.message; // Use innerText to prevent HTML design injection
                    display.appendChild(div);
                });
                display.scrollTop = display.scrollHeight;
            });
        }
    });

    document.getElementById('sendBtn').onclick = async () => {
        const msg = document.getElementById('userInput').value;
        if(!msg) return;
        const user = auth.currentUser;
        await addDoc(collection(db, "support_tickets"), {
            userId: user.uid,
            message: msg,
            sender: "USER",
            timestamp: serverTimestamp()
        });
        document.getElementById('userInput').value = "";
    };
</script>
</body>
</html>
